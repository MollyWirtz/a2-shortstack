<!doctype html>
<html lang="en">

<head>
  <title>CS4241 Assignment 2</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;500;700&family=Roboto:wght@300,700&display=swap"
    rel="stylesheet">
</head>

<body>
  <div class="head">
    <h1>Bill Tracker</h1>
  </div>
  <div class="content">
    <div class="form_div">
      <h3>Enter your bill:</h3>
      <form name="billForm" action="">
        <input type="text" id="name" value="Bill name" required>
        <input type="number" id="amt" value="0.00" required>
        <input type="date" id="date" required>
        <input type="checkbox" id="paid" value="true">
        <label for="paid">Paid?</label>

        <br><br>
        <button>Submit</button>
      </form>
      <p id="errorMsg"></p>
    </div>

    <!-- Results functionality to show entire dataset -->
    <br>
    <button id="allBillBtn" onClick="getAllBills(false)">Show all bills</button>
    <br>
    <div id="hidden" style="visibility: hidden">
      <button id="editRowBtn" style="visibility: hidden;" onClick="editEntry()">Edit Selected Rows</button>
      <button id="deleteRowBtn" style="visibility: hidden;" onClick="deleteEntry()">Delete Selected Rows</button>
      <button id="saveBtn" style="visibility: hidden;" onClick="saveChanges()">Save Changes</button>
      <div>
        <table id="all_bills">
          <tbody>
            <tr class="table_header">
              <th> </th>
              <th id="skip">Name</th>
              <th>Amount</th>
              <th>Date Issued</th>
              <th>Paid</th>
              <th>Priority</th>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // Form Submit + validation
    const submit = function (e) {
      // prevent default form action from being carried out
      e.preventDefault()
      validateForm()
      return false
    }

    // Validate form, block submission if missing fields
    function validateForm() {
      // Check all fields are filled out 
      let errorMsg = ""
      if (document.forms["billForm"]["name"].value == "") {
        errorMsg = "Please enter a bill name"
      } else if (document.forms["billForm"]["amt"].value == "") {
        errorMsg = "Please enter a bill amount"
      } else if (document.forms["billForm"]["date"].value == "") {
        errorMsg = "Please enter a date"
      }
      document.getElementById("errorMsg").innerHTML = errorMsg
      if (!errorMsg) {
        submitForm()
      }
    }

    function submitForm() {
      var computePaid = document.getElementById("paid").checked;

      const input = document.querySelector('billForm'),
        json = {
          billName: document.querySelector('#name').value,
          billAmt: document.querySelector('#amt').value,
          billDate: document.querySelector('#date').value,
          billPay: computePaid
        },

        body = JSON.stringify(json)

      fetch('/submit', {
          method: 'POST',
          body
        })
        .then(function (response) {
          // do something with the reponse 
          console.log(response)
        })

      // If all bills are expanded, update them
      if (document.getElementById("hidden").style.visibility == "visible") {
        getAllBills(true)
      }
    }

    // What is this?
    window.onload = function () {
      const button = document.querySelector('button')
      button.onclick = submit
    }

    // Retrieve all bills from server
    function getAllBills(stayOpen) {

      // If div should remain open to be updated
      if (!stayOpen) {
        // Toggle button text and div visibility
        if (document.getElementById("hidden").style.visibility == "visible") {
          document.getElementById("allBillBtn").innerHTML = "Show all bills"
          document.getElementById("hidden").style.visibility = "hidden"
        } else {
          document.getElementById("allBillBtn").innerHTML = "Hide all bills"
          document.getElementById("hidden").style.visibility = "visible"
        }
      }


      const response = fetch('/results', {
          method: 'GET'
        })
        .then(response => response.json())
        .then(function (data) {
          console.log(data)
          displayBills(data)
        })
    }

    // Display all bills in HTML
    function displayBills(jsonArray) {
      let billDiv = document.getElementById('all_bills')

      // Clear table to avoid duplication
      var rows = billDiv.rows.length
      for (let i = rows - 1; i > 0; i--) {
        billDiv.deleteRow(i)
      }

      // Populate table
      for (obj in jsonArray) {
        var newRow = document.createElement('tr')
        newRow.innerHTML =
          `<td class="checkbox_col"><input onClick="showOptions(${obj})" id=${obj} type="checkbox"></td>
      <td class="editable" id="${obj}name">${jsonArray[obj].billName}</td>
      <td class="editable" id="${obj}amt">${jsonArray[obj].billAmt}</td>
      <td class="editable" id="${obj}date">${jsonArray[obj].billDate}</td>
      <td class="editable" id="${obj}pay">${jsonArray[obj].billPay}</td>
      <td class="editable" id="${obj}priority">${jsonArray[obj].priority}</td>`
        billDiv.appendChild(newRow)
      }

    }

    function editEntry() {
      document.getElementById("saveBtn").style.visibility = "visible"

      let rows = document.getElementById('all_bills').rows.length
      let editRows = []
      let temp = []

      // Get the rows to be edited
      for (let i = 0; i < rows - 1; i++) {
        if (document.getElementById(i).checked) {
          editRows.push(i)
        }
      }
      // Get children of the row
      for (row in editRows) {
        let elt = document.getElementById(editRows[row])
        temp.push(elt.parentNode.parentNode.children)
      }
      // FINALLY get the actual editable elements in the row 
      for (tr in temp) {
        for (elt in temp[tr]){
          // Preserve id, class, and value, but change to textbox
          if (temp[tr][elt].className == "editable") { 
            temp[tr][elt].innerHTML=`<input type="text" class="editable" id=${temp[tr][elt].id} value=${temp[tr][elt].innerText}>`
          }
        }
      }

    }


    function saveChanges() {
      // Get elements that were possibly edited 
      let changedElts = []
      let inputs = document.getElementsByTagName("input")
      for (input in inputs) {
        if (inputs[input].className == "editable") {
          changedElts.push(inputs[input])
        }
      }
      console.log(changedElts)

      // Change elements back to have innerText with id, class in <td> parent elt 
        for (elt in changedElts) {
          // Set parent 
          let parent = changedElts[elt].parentNode
          parent.className = changedElts[elt].className
          parent.id = changedElts[elt].id
          parent.innerText = changedElts[elt].value
        }

        // Uncheck all checkboxes
        let rows = document.getElementById('all_bills').rows.length
        for (let i = 0; i < rows - 1; i++) {
          if (document.getElementById(i).checked) {
            document.getElementById(i).checked = false
          }
        }


    }

    function deleteEntry() {
      let rows = document.getElementById('all_bills').rows.length
      let doDelete = []
      // Iterate through rows and delete the checked row
      for (let i = 0; i < rows - 1; i++) {
        if (document.getElementById(i).checked) {
          doDelete.push(i)
        }
      }
      deleteFromServer(doDelete)

      for (row in doDelete) {
        let elt = document.getElementById(doDelete[row])
        elt.parentNode.parentNode.parentNode.removeChild(elt.parentNode.parentNode)
      }

    }

    function deleteFromServer(deleteArr) {
      let jsonObjs = []

      for (obj in deleteArr) {
        let payBool = false
        if (document.getElementById(deleteArr[obj]+'pay').innerText == 'true') { payBool = true }
        jsonObjs.push({"billName":`${document.getElementById(deleteArr[obj]+'name').innerText}`, "billAmt":`${document.getElementById(deleteArr[obj]+'amt').innerText}`, "billDate":`${document.getElementById(deleteArr[obj]+'date').innerText}`, "billPay":payBool})
      }

      //jsonObjs.push(jsonObj)
      console.log(jsonObjs)
      body = JSON.stringify(jsonObjs)
      console.log(body)

      fetch('/delete', {
          method: 'POST',
          body
        })
        .then(function (response) {
          // do something with the reponse 
          console.log(response)
        })
    }

    function showOptions(eltId) {
      let rows = document.getElementById('all_bills').rows.length
      let clear = true

      // If element was unchecked
      if (!document.getElementById(eltId).checked) {

        // Check if any other elements are currently checked 
        for (let i = 0; i < rows - 1; i++) {
          if (document.getElementById(i).checked) {
            clear = false
          }
        }
        // If nothing is checked, hide buttons
        if (clear) {
          console.log("hide")
          document.getElementById("editRowBtn").style.visibility = "hidden"
          document.getElementById("deleteRowBtn").style.visibility = "hidden"
        }
      }
      // Show buttons on checkbox check
      else {
        document.getElementById("editRowBtn").style.visibility = "visible"
        document.getElementById("deleteRowBtn").style.visibility = "visible"
      }
    }
  </script>

  <!-- <link href="js/scripts.js" type="text/javascript"> -->
</body>

</html>